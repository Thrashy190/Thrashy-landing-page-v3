---
import { frameworks, languages, cloudInfra } from "../data/stack";
import BallButton from "../components/BallButton.astro";
---

<section
  class="w-full min-h-screen bg-[#0f0f0f] px-4 grid md:grid-cols-4 grid-cols-1"
  id="tech-orbit"
>
  <!-- Marquee Mobile -->
  <div class="md:hidden w-full h-40 overflow-hidden relative flex items-center">
    <div
      class="absolute animate-marquee whitespace-nowrap text-white text-2xl font-semibold gap-6 flex"
    >
      {
        [...languages, ...frameworks, ...cloudInfra]
          .filter((t) => t.categories.includes("My Main Stack"))
          .map((t) => (
            <img
              src={`https://skillicons.dev/icons?i=${t.icon}`}
              alt={t.icon}
              class="w-10 h-10 mx-4"
            />
          ))
      }
    </div>
  </div>

  <!-- Orbitas -->
  <div
    class="hidden md:flex md:col-span-3 w-full min-h-screen justify-center items-center relative"
  >
    <div
      class="absolute w-[25rem] h-[25rem] border border-white/10 rounded-full"
      id="orbit1"
    >
      {
        languages.map((tech, i) => (
          <img
            src={`https://skillicons.dev/icons?i=${tech.icon}`}
            alt={tech.icon}
            class="orbit-icon category-icon"
            data-categories={tech.categories.join(",")}
            style={`transform: rotate(${i * (360 / languages.length)}deg) translateY(-12rem) rotate(-${i * (360 / languages.length)}deg);`}
          />
        ))
      }
    </div>

    <div
      class="absolute w-[35rem] h-[35rem] border border-white/10 rounded-full"
      id="orbit2"
    >
      {
        cloudInfra.map((tech, i) => (
          <img
            src={`https://skillicons.dev/icons?i=${tech.icon}`}
            alt={tech.icon}
            class="orbit-icon-2 category-icon"
            data-categories={tech.categories.join(",")}
            style={`transform: rotate(${i * (360 / cloudInfra.length)}deg) translateY(-18rem) rotate(-${i * (360 / cloudInfra.length)}deg);`}
          />
        ))
      }
    </div>

    <div
      class="absolute w-[45rem] h-[45rem] border border-white/10 rounded-full"
      id="orbit3"
    >
      {
        frameworks.map((tech, i) => (
          <img
            src={`https://skillicons.dev/icons?i=${tech.icon}`}
            alt={tech.icon}
            class="orbit-icon-3 category-icon"
            data-categories={tech.categories.join(",")}
            style={`transform: rotate(${i * (360 / frameworks.length)}deg) translateY(-23rem) rotate(-${i * (360 / frameworks.length)}deg);`}
          />
        ))
      }
    </div>
  </div>

  <!-- Botones Desktop -->
  <div class="hidden md:flex flex-col mt-20 items-start">
    {
      [
        "All",
        "My Main Stack",
        "Frontend Stack",
        "Backend Stack",
        "DevOps Stack",
        "AI/ML Solutions",
        "My OS favorites tools",
      ].map((cat) => <BallButton title={cat} id={cat} />)
    }

    <BallButton title="Toggle Rotation" id="toggle-spin" />
  </div>
</section>

<style>
  .orbit-icon,
  .orbit-icon-2,
  .orbit-icon-3 {
    position: absolute;
    width: 3rem;
    height: 3rem;
    transform-origin: center;
    transition:
      filter 0.3s,
      opacity 0.3s;
    opacity: 0;
  }

  .orbit-icon {
    top: 45%;
    left: 45%;
  }
  .orbit-icon-2 {
    top: 47%;
    left: 47%;
  }
  .orbit-icon-3 {
    top: 47%;
    left: 47%;
  }

  .highlighted {
    opacity: 1 !important;
  }

  @keyframes marquee {
    0% {
      transform: translateX(100%);
    }
    100% {
      transform: translateX(-100%);
    }
  }

  .animate-marquee {
    animation: marquee 20s linear infinite;
  }
</style>

<script>
  import { gsap } from "gsap";

  let orbit1Tween: any, orbit2Tween: any, orbit3Tween: any;
  let isSpinning = true;

  document.addEventListener("DOMContentLoaded", () => {
    orbit1Tween = gsap.to("#orbit1", {
      rotate: 360,
      duration: 60,
      repeat: -1,
      ease: "none",
    });

    orbit2Tween = gsap.to("#orbit2", {
      rotate: -360,
      duration: 90,
      repeat: -1,
      ease: "none",
    });

    orbit3Tween = gsap.to("#orbit3", {
      rotate: 360,
      duration: 120,
      repeat: -1,
      ease: "none",
    });

    const buttons = document.querySelectorAll(".category-button, .ball-button");
    const icons = document.querySelectorAll(".category-icon");

    buttons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const cat = btn.getAttribute("data-category") || btn.id;
        if (!cat || cat === "toggle-spin") return;

        icons.forEach((icon) => {
          const categories = icon.getAttribute("data-categories");
          if (cat === "All" || (categories && categories.includes(cat))) {
            icon.classList.add("highlighted");
          } else {
            icon.classList.remove("highlighted");
          }
        });
      });
    });

    const defaultBtn = document.querySelector('[id="All"]') as HTMLElement;
    defaultBtn?.click();

    // Toggle rotation logic
    const toggleBtn = document.getElementById("toggle-spin");
    toggleBtn?.addEventListener("click", () => {
      if (isSpinning) {
        orbit1Tween.pause();
        orbit2Tween.pause();
        orbit3Tween.pause();
      } else {
        orbit1Tween.resume();
        orbit2Tween.resume();
        orbit3Tween.resume();
      }
      isSpinning = !isSpinning;
    });
  });
</script>
